-- Q1: Write to find out which teams played the first match of the 2016 Euro Cup(IN GENERAL). 
-- Return match number, country name.

-- Selects the country name and match number from the country table */
SELECT c.country_name, md.match_no
FROM country c

-- Filters the country table by matching country_id with the team_id obtained from match_details */
WHERE c.country_id IN (
    --Retrieves team_id from match_details where match number is among the earliest played matches */
    SELECT md.team_id
    FROM match_details md
    WHERE md.match_no IN (
        -- Finds the match number(s) for the match(es) that occurred on the earliest play date */
        SELECT mm.match_no
        FROM match_mast mm
        WHERE mm.play_date = (
            -- Gets the earliest play date from the match_mast table */
            SELECT MIN(play_date) FROM match_mast )));

----------------------------------------------------------------------------
-- Q4:Write to find the match number in which Germany played against Poland.
-- Group the result set on match number. Return match number.

SELECT match_no  -- Select the match number
FROM match_details  -- The table containing match details
WHERE 
    team_id = (
        SELECT country_id  -- Get the country_id of Germany
        FROM country
        WHERE country_name LIKE 'Germany'
    )
    OR 
     team_id = (
        SELECT country_id  -- Get the country_id of Poland
        FROM country
        WHERE country_name LIKE 'Poland')
GROUP BY match_no  -- Group by match number to aggregate the teams involved in each match
HAVING COUNT(DISTINCT team_id) = 2;  -- Only include matches where both teams (Germany and Poland) participated
----------------------------------------------------------------------------
-- Q5:Write to find the result of the match where Portugal played against Hungary.
-- Return match_no, play_stage, play_date, results, goal_score.

SELECT match_no, play_stage, play_date, results, goal_score
FROM match_mast mm      -- From the match_mast table (aliased as 'mm' for convenience)
WHERE EXISTS (           -- Check if the subquery returns any rows, indicating the condition is met for each match
        SELECT 1       -- Select 1 is used because EXISTS only checks for the presence of a row, the value is not important
        FROM match_details md   -- From the match_details table (aliased as 'md')
        JOIN country c  -- Join with the country table (aliased as 'c')
        ON md.team_id = c.country_id  -- Join condition linking team_id from match_details to country_id in country
        WHERE mm.match_no = md.match_no  -- Filter to only include details related to the current match number from match_mast
        AND c.country_name IN ('Portugal', 'Hungary')  -- Only include matches involving Portugal or Hungary
        GROUP BY md.match_no   -- Group the results by match number to ensure both teams are involved in the same match
        HAVING COUNT(DISTINCT md.team_id) = 2  -- Only include matches where both teams (Portugal and Hungary) are present
    );
----------------------------------------------------------------------------
-- Q6:Write to find the players who scored goals in each match. 
-- Group the result set on match number, country name and player name. 
-- Sort the result-set in ascending order by match number.
-- Return match number, country name, player name and number of matches.

SELECT 
    c.country_name,                                 -- Select the country name
    gd.match_no,                                    -- Select the match number
    pm.player_name,                                 -- Select the player's name
    COUNT(gd.goal_id) AS goal_count                 -- Count the number of goals scored by each player
FROM 
    goal_details gd                                 -- From the goal_details table
JOIN 
    country c ON gd.team_id = c.country_id          -- Join country to get the country name
JOIN 
    player_mast pm ON gd.player_id = pm.player_id   -- Join player_mast to get the player name
GROUP BY 
    c.country_name, gd.match_no, pm.player_name     -- Group by country, match, and player
ORDER BY 
    gd.match_no ASC;                                -- Sort the result by match number in ascending order

----------------------------------------------------------------------------
-- Q?: Write to find the players who scored the most goals in each match. 
-- Group the result set on match number, country name and player name. 
-- Sort the result-set in ascending order by match number.
-- Return match number, country name, player name and number of matches.

WITH PlayerGoalCounts AS (
    -- Step 1: Count goals for each player in each match
    SELECT 
        gd.match_no, 
        c.country_name, 
        pm.player_name, 
        COUNT(gd.goal_id) AS goal_count
    FROM 
        goal_details gd
    JOIN 
        country c ON gd.team_id = c.country_id
    JOIN 
        player_mast pm ON gd.player_id = pm.player_id
    GROUP BY 
        gd.match_no, c.country_name, pm.player_name
)
-- Step 2: Find players who scored the maximum goals in each match
SELECT 
    pgc.match_no, 
    pgc.country_name, 
    pgc.player_name, 
    pgc.goal_count
FROM 
    PlayerGoalCounts pgc
-- Step 3: Filter out only players with the maximum goals per match
WHERE 
    pgc.goal_count = (
        SELECT MAX(goal_count) 
        FROM PlayerGoalCounts 
    )
ORDER BY 
    pgc.match_no ASC;

----------------------------------------------------------------------------
-- Q7:Write to find the highest audience match. Return country name of the teams.
-- Step 1: Get the audience for each match and the country names involved
WITH audence_country_table AS (
                            SELECT 
                                c.country_name, 
                                mm.match_no,             
                                mm.audence               
                            FROM 
                                match_details md
                            JOIN 
                                match_mast mm ON md.match_no = mm.match_no
                            JOIN 
                                country c ON md.team_id = c.country_id)

-- Step 2: Find the country names for matches with the highest audience

SELECT DISTINCT act.country_name
FROM audence_country_table AS act
WHERE act.match_no IN (
                        SELECT match_no
                        FROM audence_country_table
                        WHERE audence = (SELECT MAX(audence) FROM audence_country_table));

----------------------------------------------------------------------------








